<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>留言区</title>
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="bigbangri" />
  <link rel="manifest" href="/site.webmanifest" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Arial', sans-serif;
    }

    body {
      background-color: #111;
      color: white;
    }

    nav a {
      color: white;
      text-decoration: none;
      padding: 15px 25px;
      background-color: none;
      border-radius: 5px 18px;
      border: 2px solid white;
      transition: background 0.3s ease;
    }

    .jump-button {
      padding: 15px 25px;
      background-color: #111;
      color: white;
      border: 2px solid white;
      border-radius: 5px 18px;
      text-decoration: none;
      transition: all 0.3s ease;
      flex-shrink: 0;
      min-width: 120px;
      white-space: nowrap;
      text-align: center;
    }

    .jump-button:hover {
      background-color: white;
      color: black;
      cursor: pointer;
    }

    main {
      padding: 40px;
      text-align: center;
    }

    .video-item {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .video-item video {
      width: 480px;
      height: 300px;
      border-radius: 10px;
    }

    .video-description {
      display: flex;
      flex-direction: column;
      justify-content: center;
      max-width: 300px;
      text-align: left;
      line-height: 1.5;
    }

    .video-row {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-bottom: 40px;
      flex-wrap: wrap;
    }

    .video-box {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
      max-width: 350px;
    }

    .video-box.horizontal {
      flex-direction: row;
      align-items: center;
    }

    .video-box iframe {
      width: 350px;
      height: 250px;
      object-fit: cover;
      border-radius: 8px;
    }

    video {
      width: 300px;
      height: 200px;
      border-radius: 8px;
    }
    
    html {
        scroll-behavior: smooth;
    }
    
    .header-container {
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      margin-bottom: 20px;
      height: 100px;
    }

    .title-group {
      display: inline-block;
    } 

    .left-nav,
    .right-nav {
      position: absolute;
      top: 10%;
      transform: translateY(-50%);
    }

    .left-nav {
      left: 0;
    }

    .right-nav {
      right: 0;
    }

    .left-nav a,
    .right-nav a {
      padding: 18px 30px;
      font-size: 18px;
      border-radius: 5px 18px;
      color: white;
      text-decoration: none;
      border: 2px solid white;
      display: inline-block;
      transition: background 0.3s ease;
    }

    .left-nav a:hover,
    .right-nav a:hover {
      background-color: white;
      color: #111;
      cursor: pointer;
    }

    .full-width-line {
      width: 90vw;
      border: none;
      border-top: 1px solid white;
      margin-top: 10px;
      margin-bottom: 20px;
    }

@media only screen and (max-width: 768px) {
    html, body {
        height: 100vh;
        overflow-x: hidden;
        overflow-y: auto;
        position: relative;
    }

    body {
        transform: scale(0.59);
        transform-origin: top left;
        width: 169.5%;
        height: calc(100vh / 0.59);
    }

    .full-width-line {
        transform: scaleX(1.6949);
        transform-origin: left;
    }

    #global-player {
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        width: 100vw !important;
        z-index: 10000 !important;
        background: #111 !important;
        border-top: 1px solid #333 !important;
        margin: 0 !important;
        padding: 4px 6px !important;
        box-sizing: border-box !important;
        min-height: 35px !important;
        transform: none !important;
    }

    #global-player * {
        transform: none !important;
    }

    .container {
        padding-bottom: 45px !important;
    }
    
    .album-detail {
        padding-bottom: 45px !important;
    }
    
    .album-grid {
        padding-bottom: 45px !important;
    }
}

    .content-wrap {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
      margin-top: 40px;
      margin: 40px auto 0;
      max-width: 1000px;
    }

    .video-container {
      flex: 1 1 800px;
      max-width: 500px;
    }

    .video-container iframe {
        width: 450px;
        height: 350px;
        border-radius: 10px;
    }

    .video-row {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-bottom: 40px;
      flex-wrap: wrap;
    }

    .video-box {
      display: flex;
      align-items: center;
      gap: 20px;
      max-width: 600px;
    }

    .video-box iframe {
      width: 450px;
      height: 350px;
      object-fit: cover;
      border-radius: 8px;
    }

    video {
      width: 500px;
      height: 400px;
      border-radius: 8px;
    }

    .photo-container img {
      height: 350px;
      width: auto;
      display: block;
    }

    iframe {
      width: 100%;
      height: 315px;
      border: none;
    }

    .text-container {
      flex: 1 1 400px;
      max-width: 500px;
      text-align: left;
      line-height: 1.6;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .text-button-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
    }

    .button-container {
      white-space: nowrap;
      margin-top: 10px;
    }
    
    @media (max-width: 768px) {
    .text-button-container {
      flex-direction: column;
      align-items: flex-start;
      }
    }
    
    h1 {
      margin-bottom: 20px;
    }

    p {
      margin-bottom: 10px;
    }

    ul {
      padding-left: 20px;
    }

  .slider {
    display: flex;
    flex-wrap: nowrap;
    transition: transform 0.5s ease;
  }

  .slide-item {
    flex-shrink: 0;
    width: 500px;
    height: 400px;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .slide-img {
    max-height: 100%;
    max-width: 100%;
    object-fit: contain;
    display: block;
    margin: auto;
  }

  .slider-container {
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 40px auto;
    max-width: fit-content;
  }

  .slider-wrapper {
    position: relative;
    overflow: hidden;
    width: 500px;
    height: 400px;
  }

  .nav-button {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background-color: rgba(255, 255, 255, 0.7);
    border: none;
    padding: 10px 15px;
    font-size: 24px;
    cursor: pointer;
    border-radius: 10px;
    z-index: 10;
    transition: background-color 0.3s;
  }

  .nav-button.left {
    right: 100%;
    margin-right: 10px
  }

  .nav-button.right {
    left: 100%;
    margin-left: 10px;
  }

  .img-landscape {
    width: 400px;
    height: 300px;
    object-fit: contain;
  }

  .img-portrait {
    width: 300px;
    height: 400px;
    object-fit: contain;
  }


    body {
      background: #111;
      color: #fff;
      font-family: sans-serif;
      padding: 20px;
    }
    .comment-box {
      max-width: 800px;
      margin: 0 auto;
    }
    .comment-form {
      margin-top: 10px;
    }
    .form-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .form-row input,
    .form-row textarea {
      flex: 1;
      min-width: 240px;
      padding: 8px;
      border-radius: 6px;
      background-color: #111;
      color: white;
      border: 1px solid white;
      box-sizing: border-box;
    }
.comment-form button {
  margin-top: 10px;
  padding: 12px 25px;
  border-radius: 2px 15px;
  border: 1px solid white;
  background: #111;
  color: white;
  cursor: pointer;
  font-size: 15px;
}
.comment-form button:hover {
  border: 1px solid #111;
  background: white;
  color: #111;
}
.admin-btn {
  margin-top: 10px;
  padding: 12px 25px;
  border-radius: 2px 15px;
  border: none;
  background: none;
  color: white;
  cursor: pointer;
  font-size: 15px;
}
.admin-btn:hover {
  color: #00aaff;
}
.comment {
  background: #1e1e1e;
  padding: 12px;
  border-radius: 8px;
  margin-top: 16px; /* 原来是16px */
  text-align: left;
}
    .comment-text {
      font-size: 19px;
      margin-bottom: 8px;
      white-space: pre-wrap;
    }
    .comment-meta-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      color: #111;
    }
    .comment-name {
      color: white;
    }
    .comment-date {
      color: white;
    }
    .reply-btn,
    .delete-btn {
      font-size: 12px;
      color: #00aaff;
      cursor: pointer;
      margin-right: 10px;
    }
    .delete-btn {
      color: #ff5555;
    }
    .reply-form {
      margin-top: 10px;
      padding-left: 20px;
    }

    .reply-form input,
    .reply-form textarea {
      background-color: #111;
      color: white;
      border: 1px solid white;
      padding: 8px;
      border-radius: 6px;
      margin-bottom: 6px;
      width: 100%;
      box-sizing: border-box;
    }
    .reply-form button {
      background: #111;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    .replies {
      margin-top: 10px;
      padding-left: 20px;
    }
    #admin-login {
      margin-bottom: 10px;
      text-align: right;
    }
.reply-like-btn {
  color: #00aaff;
  font-size: 13px;
  opacity: 1;
  transition: color 0.2s;
  cursor: pointer;
}
.reply-btn:hover,
.reply-like-btn:hover {
  color: white;
}
.filter-buttons {
  display: flex;
  justify-content: flex-end;
  gap: 15px;
  margin-bottom: 10px;
}

.filter-btn {
  background: none;
  border: none;
  color: #aaa;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.filter-btn:hover {
  color: white;
}

.filter-btn.active {
  color: white;
  font-size: 18px;
  font-weight: bold;
}
html {
  scroll-behavior: auto !important;
}
.comments-placeholder {
  visibility: hidden;
}
  </style>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyB1xOMQRikCjQiXoxPSPTNC1gXUTacbtZs",
    authDomain: "bigbangri.firebaseapp.com",
    projectId: "bigbangri",
    storageBucket: "bigbangri.appspot.com",
    messagingSenderId: "106865552451",
    appId: "1:106865552451:web:fd79e565c"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>
</head>
<body>
<main>
  <div class="header-container">
    <nav class="left-nav">
      <a href="index.html">Back</a>
    </nav>
    <div class="title-group">
      <h1>留言区</h1>
    </div>
  </div>
  <p>请各位粉丝们注意言行，用词不当如用黑称或引战类的言论将被管理员删评</p>

<div class="comment-box">
<div id="admin-login" style="display: flex; justify-content: space-between;">
  <button class="admin-btn left-btn" onclick="changeUsername()">修改名字</button>
  <button class="admin-btn right-btn" onclick="loginAdmin()">管理员</button>
</div>
  <div class="comment-form">
    <div class="form-row">
      <input type="text" id="name" placeholder="你的名字（建议使用微博名字）" required>
      <textarea id="message" rows="4"></textarea>
    </div><br/>
    <button onclick="addComment()">发送</button>
  </div>
    <div class="filter-buttons">
  <button class="filter-btn active" onclick="setFilterMode('all')">最旧</button>
  <button class="filter-btn" onclick="setFilterMode('latest')">最新</button>
  <button class="filter-btn" onclick="setFilterMode('hot')">最火</button>
</div>
  <div id="comments"></div>
</div>

<br/><br/>
<p style="text-align: center; padding: 20px; color: rgb(242, 242, 242);">
  Copyright © bigbangri.com All rights reserved.
</p>
</main>
<script src="player.js"></script>
<script>
  document.getElementById("message").placeholder = "你的评论内容...\n\n请大家谨慎发言（ot3 ot4 这辈子最大的敌人就是权志龙）";

let unsubscribeFirestore = null;

const blockedWords = [
  "法制咖", "黄赌毒", "强奸", "下药", "吸毒", "李失败", "前夫哥", "拉皮条", "毒贩", 
  "罪犯", "犯罪", "傻逼", "sb", "神经病", "n号房", "赌博", "fzk", "lpt"
];

// 屏蔽词检测函数
function containsBlockedWords(text) {
  return blockedWords.some(word => text.includes(word));
}

async function addComment() {
  let nameInput = document.getElementById("name");
  let name = nameInput ? nameInput.value.trim() : localStorage.getItem("comment_username");
  const message = document.getElementById("message").value.trim();

  if (!name || !message) {
    alert("请填写名字和评论内容");
    return;
  }

  // ✅ 屏蔽词过滤
  if (containsBlockedWords(message)) {
    alert("你的评论内容包含违规词汇，请修改后再发送。");
    return;
  }

  // ✅ 如果本地没有保存用户名，则检查是否重复
  if (!localStorage.getItem("comment_username")) {
    try {
      const snapshot = await db.collection("comments").where("name", "==", name).limit(1).get();
      if (!snapshot.empty) {
        alert("该用户名已被使用，请更换一个名字");
        return;
      }
    } catch (error) {
      console.error("检查用户名重复出错：", error);
      alert("无法验证用户名是否重复，请稍后再试");
      return;
    }

    // ✅ 本地保存用户名（避免下次重复检查）
    localStorage.setItem("comment_username", name);
    if (nameInput) nameInput.style.display = "none";
  }

  // ✅ 构建评论对象并提交
  const comment = {
    name,
    message,
    date: getChineseDate(),
    replies: []
  };

  try {
    await db.collection("comments").add({
      ...comment,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById("message").value = "";
  } catch (e) {
    console.error("发送评论失败", e);
    alert("评论发送失败，请稍后再试");
  }
}

let comments = [];
let isAdmin = false;
const adminPasswordHash = "48d5d9fb215fe9acb1c094a4ef3c2d7addeb114f9681b842c20a998e32281445";

function getChineseDate() {
  const now = new Date();
  const datePart = `${now.getFullYear()}年${String(now.getMonth()+1).padStart(2,'0')}月${String(now.getDate()).padStart(2,'0')}日`;
  const timePart = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
  return `${datePart} ${timePart}`;
}

function renderCommentsRealtime() {
  if (unsubscribeFirestore) unsubscribeFirestore();
  unsubscribeFirestore = db.collection("comments")
    .orderBy("timestamp")
    .onSnapshot(snapshot => {
      comments = [];
      snapshot.forEach(doc => {
        comments.push({ id: doc.id, ...doc.data() });
      });
      renderComments();
    });
}

function saveCommentToFirestore(comment) {
  comment.timestamp = firebase.firestore.FieldValue.serverTimestamp();
  db.collection("comments").add(comment);
}

function deleteCommentFromFirestore(commentId) {
  db.collection("comments").doc(commentId).delete().then(() => {
    console.log("删除成功");

    // ✅ 1. 同步本地 comments 数组
    comments = comments.filter(c => c.id !== commentId);

    // ✅ 2. 清空并重新渲染
    renderComments();

  }).catch((error) => {
    console.error("删除失败: ", error);
  });
}


function updateRepliesToFirestore(commentId, updatedReplies) {
  db.collection("comments").doc(commentId).update({
    replies: updatedReplies
  }).then(() => {
    console.log("回复删除成功");

    // ✅ 重新渲染一次
    renderComments();

  }).catch((error) => {
    console.error("回复删除失败: ", error);
  });
}

function renderComments() {
  const container = document.getElementById("comments");
  container.innerHTML = "";
  comments.forEach((c, index) => {
    container.appendChild(createCommentElement(c, index));
  });
}

function createCommentElement(comment, index) {
  const div = document.createElement("div");
  div.className = "comment";
  div.style.position = "relative";

  const text = document.createElement("p");
  text.className = "comment-text";
  text.textContent = comment.message;

  const infoRow = document.createElement("div");
  infoRow.className = "comment-meta-row";

  const name = document.createElement("span");
  name.className = "comment-name";
  name.textContent = comment.name;

  const date = document.createElement("span");
  date.className = "comment-date";
  date.textContent = comment.date;

  infoRow.appendChild(name);
  infoRow.appendChild(date);

  const likeBtn = document.createElement("span");
  likeBtn.className = "reply-btn";
  likeBtn.style.position = "absolute";
  likeBtn.style.top = "12px";
  likeBtn.style.right = "12px";

  const likedKey = `liked_${comment.id}`;
  let liked = localStorage.getItem(likedKey) === "true";
  let currentLikes = comment.likes || 0;
  likeBtn.textContent = `❤ ${currentLikes}`;

  likeBtn.onclick = async () => {
    const commentRef = db.collection("comments").doc(comment.id);
    const likedKey = `liked_${comment.id}`;
    let liked = localStorage.getItem(likedKey) === "true";

    try {
      const doc = await commentRef.get();
      if (!doc.exists) return;

      let currentLikes = doc.data().likes || 0;

      if (!liked) {
        currentLikes += 1;
        await commentRef.update({ likes: currentLikes });
        localStorage.setItem(likedKey, "true");
      } else {
        currentLikes = Math.max(0, currentLikes - 1);
        await commentRef.update({ likes: currentLikes });
        localStorage.setItem(likedKey, "false");
      }

      likeBtn.textContent = `❤ ${currentLikes}`;
    } catch (error) {
      console.error("点赞失败", error);
    }
  };

const actionRow = document.createElement("div");
actionRow.style.display = "flex";
actionRow.style.alignItems = "center";
actionRow.style.gap = "2px";
actionRow.style.marginTop = "6px";

const replyBtn = document.createElement("span");
replyBtn.className = "reply-btn";
replyBtn.textContent = "回复";
replyBtn.onclick = () => showReplyForm(div, index);
actionRow.appendChild(replyBtn);

const savedName = localStorage.getItem("comment_username");
// ✅ 本人或管理员都能删评论
if ((savedName && comment.name === savedName) || isAdmin) {
  const deleteBtn = document.createElement("span");
  deleteBtn.className = "delete-btn";
  deleteBtn.textContent = "删除";
  deleteBtn.onclick = () => {
    if (confirm("确定要删除这条评论吗？")) {
      deleteCommentFromFirestore(comment.id);
    }
  };
  actionRow.appendChild(deleteBtn);
}

  div.appendChild(text);
  div.appendChild(infoRow);
  div.appendChild(actionRow);
  div.appendChild(likeBtn);

  if (comment.replies && comment.replies.length > 0) {
    const repliesDiv = document.createElement("div");
    repliesDiv.className = "replies";
    comment.replies.forEach((reply, replyIndex) => {
      repliesDiv.appendChild(createReplyElement(reply, index, replyIndex));
    });
    div.appendChild(repliesDiv);
  }

  return div;
}

function createReplyElement(reply, parentIndex, replyIndex) {
  const div = document.createElement("div");
  div.className = "comment";
  div.style.position = "relative";

  const text = document.createElement("p");
  text.className = "comment-text";
  text.textContent = reply.message;

  const infoRow = document.createElement("div");
  infoRow.className = "comment-meta-row";

  const name = document.createElement("span");
  name.className = "comment-name";
  name.textContent = reply.name;

  const date = document.createElement("span");
  date.className = "comment-date";
  date.textContent = reply.date;

  infoRow.appendChild(name);
  infoRow.appendChild(date);

  // 点赞按钮
  const replyLikeBtn = document.createElement("span");
  replyLikeBtn.className = "reply-like-btn";
  replyLikeBtn.style.position = "absolute";
  replyLikeBtn.style.top = "12px";
  replyLikeBtn.style.right = "12px";

  const replyLikedKey = `liked_reply_${comments[parentIndex].id}_${replyIndex}`;
  let replyLiked = localStorage.getItem(replyLikedKey) === "true";
  let replyLikes = reply.likes || 0;
  replyLikeBtn.textContent = `❤ ${replyLikes}`;

  replyLikeBtn.onclick = async () => {
    const commentRef = db.collection("comments").doc(comments[parentIndex].id);
    const doc = await commentRef.get();
    if (!doc.exists) return;

    let updatedReplies = doc.data().replies || [];
    let currentLikes = updatedReplies[replyIndex].likes || 0;
    replyLiked = localStorage.getItem(replyLikedKey) === "true";

    if (!replyLiked) {
      currentLikes += 1;
      localStorage.setItem(replyLikedKey, "true");
    } else {
      currentLikes = Math.max(0, currentLikes - 1);
      localStorage.setItem(replyLikedKey, "false");
    }

    updatedReplies[replyIndex].likes = currentLikes;
    await commentRef.update({ replies: updatedReplies });
    replyLikeBtn.textContent = `❤ ${currentLikes}`;
    replyLikeBtn.style.color = localStorage.getItem(replyLikedKey) === "true" ? "#00aaff" : "white";
  };

const replyRow = document.createElement("div");
replyRow.style.display = "flex";
replyRow.style.alignItems = "center";
replyRow.style.gap = "5px";
replyRow.style.marginTop = "6px";

// 回复按钮
const replyBtn = document.createElement("span");
replyBtn.className = "reply-btn";
replyBtn.textContent = "回复";
replyBtn.onclick = () => showReplyForm(div, parentIndex, reply.name);
replyRow.appendChild(replyBtn);

// 如果需要显示 @用户名
if (reply.replyTo && reply.replyTo !== comments[parentIndex].name) {
  const atTag = document.createElement("span");
  atTag.style.color = "white";
  atTag.style.fontSize = "13px";
  atTag.textContent = `··· ${reply.replyTo}`;
  replyRow.appendChild(atTag);
}

const savedName = localStorage.getItem("comment_username");
// ✅ 本人或管理员都能删回复
if ((savedName && reply.name === savedName) || isAdmin) {
  const deleteBtn = document.createElement("span");
  deleteBtn.className = "delete-btn";
  deleteBtn.textContent = "删除";
  deleteBtn.onclick = () => {
    if (confirm("确定要删除这条回复吗？")) {
      const updatedReplies = [...comments[parentIndex].replies];
      updatedReplies.splice(replyIndex, 1);
      updateRepliesToFirestore(comments[parentIndex].id, updatedReplies);
    }
  };
  replyRow.appendChild(deleteBtn);
}

  // 渲染到页面
  div.appendChild(text);
  div.appendChild(infoRow);
  div.appendChild(replyRow);
  div.appendChild(replyLikeBtn);

  return div;
}

  function showReplyForm(parentDiv, parentIndex, replyToName = null) {
    if (parentDiv.querySelector(".reply-form")) return;

    const form = document.createElement("div");
    form.className = "reply-form";

    const savedName = localStorage.getItem("comment_username");
    const nameInput = document.createElement("input");
    nameInput.placeholder = "你的名字";
    if (savedName) {
      nameInput.value = savedName;
      nameInput.style.display = "none";
    }

    const messageInput = document.createElement("textarea");
    messageInput.rows = 3;
    messageInput.placeholder = "回复内容...";

    const sendBtn = document.createElement("button");
    sendBtn.textContent = "发送回复";
    sendBtn.onclick = async () => {
      const name = savedName || nameInput.value.trim();
      const message = messageInput.value.trim();
      if (!name || !message) {
        alert("请填写名字和回复内容");
        return;
      }
      if (containsBlockedWords(message)) {
        alert("回复内容包含违规词汇，请修改后再发。");
        return;
      }
      if (!savedName) {
        localStorage.setItem("comment_username", name);
        nameInput.style.display = "none";
      }

      const reply = {
        name,
        message,
        date: getChineseDate(),
        replyTo: replyToName || comments[parentIndex].name,
        likes: 0
      };

      const updatedReplies = [...comments[parentIndex].replies, reply];
      await db.collection("comments").doc(comments[parentIndex].id).update({ replies: updatedReplies });
    };

    form.appendChild(nameInput);
    form.appendChild(messageInput);
    form.appendChild(sendBtn);
    parentDiv.appendChild(form);
  }

async function hashPassword(password) {
  const msgUint8 = new TextEncoder().encode(password);
  const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

async function loginAdmin() {
  const pwd = prompt("你是管理员吗你就点");
  const hashed = await hashPassword(pwd.trim());
  if (hashed === adminPasswordHash) {
    isAdmin = true;
    alert("管理员验证成功，可删除评论");
    renderComments();
  } else {
    alert("错误");
  }
}

renderCommentsRealtime();

function changeUsername() {
  const oldName = localStorage.getItem("comment_username");
  const newName = prompt("请输入新的名字：", oldName || "");

  if (!newName || newName.trim() === "") {
    alert("名字不能为空");
    return;
  }

  if (newName === oldName) {
    alert("新名字和旧名字不能相同");
    return;
  }

  localStorage.setItem("comment_username", newName);

  // 更新 Firestore 中所有该用户名的评论和回复
  db.collection("comments").get().then(snapshot => {
    const batch = db.batch();

    snapshot.forEach(doc => {
      const data = doc.data();
      let updated = false;

      // 更新主评论的名字
      if (data.name === oldName) {
        doc.ref.update({ name: newName });
        updated = true;
      }

      // 更新楼中楼回复的名字
      const replies = data.replies || [];
      let modified = false;
      const updatedReplies = replies.map(reply => {
        if (reply.name === oldName) {
          modified = true;
          return { ...reply, name: newName };
        }
        return reply;
      });

      if (modified) {
        doc.ref.update({ replies: updatedReplies });
        updated = true;
      }
    });

    alert("名字已修改，评论也同步更新（不许随便改名字）");
  });
}

function setFilterMode(mode) {
  const container = document.getElementById("comments");

  // 保存当前滚动位置
  const currentScrollY = window.scrollY;

  // 临时设置高度占位，防止跳动
  const originalHeight = container.offsetHeight;
  container.style.minHeight = originalHeight + "px";
  container.classList.add("comments-placeholder");

  // 切换按钮样式
  document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
  const labelMap = { all: '最旧', latest: '最新', hot: '最火' };
  document.querySelectorAll('.filter-btn').forEach(btn => {
    if (btn.textContent.trim() === labelMap[mode]) {
      btn.classList.add('active');
    }
  });

  // 清除监听
  if (unsubscribeFirestore) unsubscribeFirestore();

  // 延迟渲染以保持位置
  setTimeout(() => {
    if (mode === 'all') {
      renderCommentsRealtime();
    } else if (mode === 'latest') {
      showLatestComments();
    } else if (mode === 'hot') {
      showMostLikedComments();
    }

    // 渲染后恢复高度和可见性
    setTimeout(() => {
      container.classList.remove("comments-placeholder");
      container.style.minHeight = "0px";
      window.scrollTo({ top: currentScrollY });
    }, 0);
  }, 0);
}

function showLatestComments() {
  if (comments.length === 0) return alert("暂无评论");

  const sorted = [...comments].sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
  const container = document.getElementById("comments");
  container.innerHTML = "";
  sorted.forEach((comment, index) => {
    container.appendChild(createCommentElement(comment, comments.findIndex(c => c.id === comment.id)));
  });
}

function showMostLikedComments() {
  if (comments.length === 0) return alert("暂无评论");

  const sorted = [...comments].sort((a, b) => (b.likes || 0) - (a.likes || 0));
  const container = document.getElementById("comments");
  container.innerHTML = "";
  sorted.forEach((comment, index) => {
    container.appendChild(createCommentElement(comment, comments.findIndex(c => c.id === comment.id)));
  });
}
function renderCommentsRealtime() {
  if (unsubscribeFirestore) unsubscribeFirestore();
  unsubscribeFirestore = db.collection("comments")
    .orderBy("timestamp")
    .onSnapshot(snapshot => {
      comments = [];
      snapshot.forEach(doc => {
        comments.push({ id: doc.id, ...doc.data() });
      });
      renderComments();
    });
}
window.addEventListener("DOMContentLoaded", () => {
  const savedName = localStorage.getItem("comment_username");
  if (savedName) {
    const nameInput = document.getElementById("name");
    if (nameInput) {
      nameInput.value = savedName;
      nameInput.style.display = "none"; // ✅ 隐藏输入框
    }
  }
});
</script>
</body>
</html>
